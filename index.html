// --- BEGIN: hash-based loader ---
// Base raw URL for your GitHub repo (change if repo/path khác)
const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/HoangQuan1206/BodySex/refs/heads/main/";

// sanitize filename: chỉ cho phép ký tự an toàn (chữ, số, gạch, _, ., -)
function sanitizeFilename(name) {
  // loại bỏ các ký tự không mong muốn
  const safe = name.replace(/[^A-Za-z0-9._\-\/:]/g, "");
  // tránh path traversal (nhiều dấu ../)
  if (safe.includes("..")) return null;
  return safe;
}

// Lấy filename / url từ fragment (location.hash)
function urlFromHash(hash) {
  if (!hash) return null;
  let h = hash.startsWith("#") ? hash.slice(1) : hash;
  h = decodeURIComponent(h.trim());
  // nếu là full url thì dùng luôn
  if (/^https?:\/\//i.test(h)) {
    return sanitizeFilename(h) ? h : null;
  }
  // nếu chứa đường dẫn con (ví dụ folder/file.lua) thì cũng cho phép (sau sanitize)
  const safe = sanitizeFilename(h);
  if (!safe) return null;
  return GITHUB_RAW_BASE + safe;
}

// Khi trang load, nếu có hash thì set rawUrl và fetch tự động
function handleHashLoad() {
  const rawFromHash = urlFromHash(window.location.hash);
  if (rawFromHash) {
    rawUrlEl.value = rawFromHash;
    fetchRaw(rawFromHash);
    setStatus("Đang tải từ fragment: " + window.location.hash);
  } else {
    // không hợp lệ/không có: giữ behavior mặc định (DEFAULT_RAW)
    setStatus("Không có fragment hợp lệ — dùng file mặc định.");
    // nếu bạn muốn tự động tải DEFAULT_RAW, uncomment:
    // fetchRaw(DEFAULT_RAW);
  }
}

// Lắng nghe thay đổi hash (nếu user cập nhật link mà không reload)
window.addEventListener("hashchange", () => {
  handleHashLoad();
});

// gọi 1 lần khi khởi tạo
handleHashLoad();
// --- END: hash-based loader ---
